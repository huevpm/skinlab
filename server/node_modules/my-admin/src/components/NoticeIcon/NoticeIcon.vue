<template>
    <a-popover v-model="visible" trigger="click" placement="bottomRight" overlayClassName="header-notice-wrapper" :getPopupContainer="() => $refs.noticeRef.parentElement" :autoAdjustOverflow="true" :arrowPointAtCenter="true" :overlayStyle="{ width: '300px', top: '50px' }">
        <template slot="content">
            <a-spin :spinning="loading">
                <a-tabs @change="tabChange">
                    <a-tab-pane tab="消息" key="1">
                        <a-list>
                            <a-list-item v-for="item,index in msg_list" :key="index" style="cursor:pointer" @click="showMsg(item)">
                                <a-list-item-meta :title="item.messages.title" :description="item.messages.addtime">
                                    <a-avatar style="background-color: white" slot="avatar" :src="item.user.avatar" />
                                </a-list-item-meta>
                            </a-list-item>
                        </a-list>
                    </a-tab-pane>
                    <a-tab-pane tab="通知" key="2">
                        <a-list>
                            <a-list-item v-for="v,k in msg2_list" :key="k" style="cursor:pointer" @click="showMsg(v)">
                                <a-list-item-meta :title="v.messages.title" :description="v.messages.addtime">
                                    <a-avatar style="background-color: white" slot="avatar" :src="v.user.avatar" />
                                </a-list-item-meta>
                            </a-list-item>
                        </a-list>
                    </a-tab-pane>
                    <!-- <a-tab-pane tab="待办" key="3">123</a-tab-pane> -->
                </a-tabs>
                <div style="height:20px;border-top:0.2px solid #e8e8e8;padding-top: 5px;">
                    <a style="display:inline-block;width:49%;line-height: 20px;text-align: center;border-right: 1px solid #ccc" @click="allRead">当前标记为已读</a>
                    <router-link :to="{ path: '/system/messages' }">
                        <a style="display:inline-block;width:49%;line-height: 20px;text-align: center;" @click="visible = !visible">查看所有</a>
                    </router-link>
                </div>
            </a-spin>
        </template>
        <span @click="fetchNotice" class="header-notice" ref="noticeRef" style="padding: 0 18px">
            <a-badge :count="count">
                <a-icon style="font-size: 16px; padding: 4px" type="bell" />
            </a-badge>
        </span>
    </a-popover>
</template>
<script>
import { Modal } from 'ant-design-vue';
export default {
    name: 'HeaderNotice',
    data() {
        return {
            loading: false,
            visible: false,
            count: 0,
            msg_list: [{
                messages: {
                    title: '',
                    addtime: ''
                },
                user: {
                    avatar: ''
                }
            }],
            msg2_list: [{
                messages: {
                    title: '',
                    addtime: ''
                },
                user: {
                    avatar: ''
                }
            }],
            tab_key: 1
        }
    },
    async mounted() {
        // let that = this;
        // this.$cloud.socket.login({ userId: this.userid })
        // this.$cloud.socket.receive((res) => {
        //     console.log(res)
        //     if (res === 'getmsg') {
        //         that.$notification.info({
        //             message: "你收到了新消息,请查看"
        //         });
        //         that.getmsg()
        //     }
        // })
        this.insMsg()
    },
    methods: {
        insMsg() {
            this.$cloud.messages().ins_msg().then(res => {
                this.msgCount()
                this.getmsg()
            })
        },
        msgCount() {
            this.$cloud.messages().count({ status: 0, deleted: 0 }).then(res => {
                this.count = res
            })
        },
        getmsg() {
            this.$cloud.messages().get({ msg_type: 1 }).then(res => {
                this.msg_list = res
            })
            this.$cloud.messages().get({ msg_type: 2 }).then(res2 => {
                this.msg2_list = res2
            })

        },
        showMsg(data) {
            let that = this;
            let h = this.$createElement;
            this.$info({
                title: data.messages.title,
                content: h('div', {}, [
                    h('p', data.messages.content)
                ]),
                onOk() {
                    if (data.status === 0) {
                        that.$cloud.messages().read({ _id: data._id }).then(res => {
                            that.insMsg()
                        })
                    }
                }
            });
        },
        fetchNotice() {
            // if (!this.visible) {
            //   this.loading = true
            //   setTimeout(() => {
            //     this.loading = false
            //   }, 2000)
            // } else {
            //   this.loading = false
            // }
            this.visible = !this.visible
        },
        tabChange(e) {
            this.tab_key = e
        },
        async allRead() {
            let where = [];
            if (this.tab_key == 1) {
                for (let i in this.msg_list) {
                    where.push(this.msg_list[i]._id)
                }
            } else {
                for (let i in this.msg2_list) {
                    where.push(this.msg2_list[i]._id)
                }
            }


            if (where[0]) {
                let res = await this.$cloud.messages().read({ _id: ['in', where] });
                if (res) {
                    this.$message.success('操作成功');
                    this.insMsg()
                }
            }

            this.visible = !this.visible

        }
    }
}
</script>
<style lang="css">
.header-notice-wrapper {
    top: 50px !important;
}
</style>
<style lang="less" scoped>
.header-notice {
    display: inline-block;
    transition: all 0.3s;

    span {
        vertical-align: initial;
    }
}
</style>