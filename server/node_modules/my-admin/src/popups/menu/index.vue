<template>
  <a-form :form="form">
    <a-form-item label="菜单标题" :labelCol="labelCol" :wrapperCol="wrapperCol" hasFeedback>
      <a-input v-decorator="[
            'title',
            {rules: [{ required: true, message: '请输入菜单标题' }]}
          ]" placeholder="请输入菜单标题" />
    </a-form-item>
    <a-form-item label="菜单名称" :labelCol="labelCol" :wrapperCol="wrapperCol" :hasFeedback="menuId?false:true">
      <a-input ref="pageName" v-decorator="[
            'name',
            {rules: [{ required: true, message: '请输入菜单名称', whitespace: true}, {validator: validate}]}
          ]" placeholder="请输入菜单名称" :disabled="menuId?true:false" />
    </a-form-item>
    <a-form-item label="菜单父级" :labelCol="labelCol" :wrapperCol="wrapperCol" hasFeedback>
      <a-cascader v-decorator="[
          'path',
          {
            rules: [
              { type: 'array', required: true, message: '选择菜单父级别' },
            ],
          },
        ]" :options="residences" changeOnSelect placeholder="选择菜单父级别" />
    </a-form-item>
    <a-form-item v-show="form.getFieldValue('path') && form.getFieldValue('path')[0]!==0" label="菜单类型" :labelCol="labelCol" :wrapperCol="wrapperCol">
      <a-radio-group v-decorator="['type', { initialValue: 'PATH',rules: [{ message: '菜单类型' }]}]">
        <a-radio value="PATH">
          目录
        </a-radio>
        <a-radio value="PAGE">
          页面
        </a-radio>
      </a-radio-group>
    </a-form-item>
    <a-form-item v-show="form.getFieldsValue().path && form.getFieldsValue().path[0]===0" label="菜单模板" :labelCol="labelCol" :wrapperCol="wrapperCol" hasFeedback>
      <a-select v-decorator="[
          'component',
          { initialValue: 'PageView',rules: [{ message: '选择模板' }] },
        ]" placeholder="请选择模板">
        <a-select-option value="RouteView">
          路由模板
        </a-select-option>
        <a-select-option value="PageView">
          页面模板
        </a-select-option>
      </a-select>
    </a-form-item>
    <a-form-item label="菜单图标" :labelCol="labelCol" :wrapperCol="wrapperCol" hasFeedback>
      <a-input v-decorator="[
            'icon',
            {rules: [{message: '请输入菜单图标' }]}
          ]" placeholder="请输入菜单图标" />
    </a-form-item>
    <a-form-item label="是否显示" :labelCol="labelCol" :wrapperCol="wrapperCol">
      <a-switch v-decorator="['show', { valuePropName: 'checked',initialValue:true }]" checkedChildren="显示" unCheckedChildren="隐藏" />
    </a-form-item>
    <a-divider v-show="form.getFieldValue('type')=='PAGE'" />
    <a-form-item v-show="form.getFieldValue('type')=='PAGE'" :labelCol="labelCol" :wrapperCol="wrapperCol" label="权限规则">
      <a-select style="width: 100%" mode="multiple" :allowClear="true" v-decorator="[
            'rules',
             {initialValue: []}
          ]" placeholder="权限规则">
        <a-select-option v-for="(action, index) in rulesList" :key="index" :value="action.name">{{ action.title }}</a-select-option>
      </a-select>
    </a-form-item>
  </a-form>
</template>
<script>
import Vue from 'vue'
import { Cascader, AutoComplete, message } from 'ant-design-vue'

Vue.use(message);
Vue.use(Cascader);
Vue.use(AutoComplete);

export default {
  props: {
    value: [Array, Object, Number, String]
  },
  data() {
    return {
      labelCol: {
        xs: { span: 24 },
        sm: { span: 5 }
      },
      wrapperCol: {
        xs: { span: 24 },
        sm: { span: 16 }
      },
      residences: [],
      rulesList: [],
      menuId: 0,
      // form
      form: this.$form.createForm(this)

    }
  },
  /**
   * 页面加载执行
   * @return {[type]} [description]
   */
  async mounted() {
    if (JSON.stringify(this.value) !== "[]") {
      let res = this.value;
      this.menuId = this.value.menuId;
      let _default = {
        title: res.title,
        name: res.name,
        path: res.path,
        component: res.component || "",
        icon: res.icon || "",
        type: res.type,
        show: Boolean(res.show),
        rules: res.rules || []
      };
      this.form.setFieldsValue(_default)
    }
     this.getMenus();
     this.getRules();
  },
  methods: {
     getMenus() {
      this.$cloud.menus().all().then(res => {
        let toTree = {
          parentKey: "parentId",
          idKey: "menuId",
          parentId: 0,
          childrenKey: "children"
        }
        let residences = this.$cloud.tree(toTree).field("label", (value, self) => {
          return self['title'];
        }).field("value", (value, self) => {
          return self['menuId']
        }).add("value", "").add("label", "").on(res).get();
        residences.unshift({
          value: 0,
          label: '顶级菜单'
        })
        this.residences = residences;
      });
    },
    async getRules() {
      await this.$cloud.rules().all().then(res => {
        this.rulesList = res;
      }).catch(error => {
        console.log("查看错误", error)
      });
    },
    async validate(rule, value, callback) {
      if (value) {
        const regex = /^[a-zA-Z][\w]+$/
        if (!regex.test(value)) {
          callback(new Error('必须以字母开头，且为字母或数字'))
        }
        if (this.menuId === 0) {
          let returned = await this.$cloud.menus().check(value);
          if (returned) {
            callback(new Error('菜单名称已经存在'))
          }
        }
        callback()
      }
    },
    // handler
    affirm(e) {
      let { handleCancel } = e;
      let { $cloud, menuId, addMenu, editMenu } = this;
      return this.form.validateFields((err, values) => {
        if (!err) {
          let _vleng = values.path.length;
          values.parentId = values.path[_vleng - 1] || 0;
          values.show = values.show || false;
          if (values.path[0] === 0) {
            values.path[0] = []
          } else {
            values.component = "";
          }
          if (menuId === 0) {
            addMenu(values);
          } else {
            editMenu(menuId,values);
          }
          handleCancel();
        }
      })
    },
    /**
     * 判断名称
     * @return {[type]} [description]
     */
    onJudgment() {

    },
    addMenu(values) {
      let { $message } = this;
      this.$cloud.menus().add(values).then(res => {
        $message.success("提交成功");
      })
    },
    editMenu(id,values) {
      let { $message } = this;
      this.$cloud.menus().edit(id,values).then(res => {
        $message.success("更新成功");
      })
    }
  }
}
</script>