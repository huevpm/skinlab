<template>
    <div>
        <a-card style="margin-top: 24px" :bordered="false">
            <div slot="title">
                <a-button type="primary" icon="plus" v-popup.user>添加用户</a-button>
            </div>
            <div slot="extra">
                <a-button type="primary" icon="sound" @click="showModal()">群发消息</a-button>
                <!-- <a-radio-group v-model="status">
          <a-radio-button value="all">全部</a-radio-button>
          <a-radio-button value="processing">启用</a-radio-button>
          <a-radio-button value="waiting">禁用</a-radio-button>
        </a-radio-group>
        <a-input-search style="margin-left: 16px; width: 272px;" /> -->
            </div>
            <a-list size="large" style="text-align: center;">
                <a-list-item :key="index" v-for="(item, index) in userList" class="list-item">
                    <a-list-item-meta :description="'ID：'+item._id">
                        <a-avatar slot="avatar" style="backgroundColor:#87d068" icon="user" size="large" shape="square" :src="item.avatar" />
                        <span slot="title">{{ item.nickname || item.username || '未设置昵称' }}</span>
                    </a-list-item-meta>
                    <div slot="actions">
                        <a v-popup.user="item" :data-id="item._id">编辑</a>
                    </div>
                    <div slot="actions">
                        <a-dropdown>
                            <a-menu slot="overlay">
                                <a-menu-item><a @click="showModal(item)">发送信息</a></a-menu-item>
                                <a-menu-item><a v-popup.password="item">修改密码</a></a-menu-item>
                                <a-menu-item><a @click="Del(item._id)">删除用户</a></a-menu-item>
                            </a-menu>
                            <a>更多
                                <a-icon type="down" /></a>
                        </a-dropdown>
                    </div>
                    <div class="list-content">
                        <div class="list-content-item" style="width:15%">
                            <a-switch checkedChildren="启用" unCheckedChildren="禁止" :checked="item.status" @change="statusChange(item)" />
                        </div>
                        <div class="list-content-item" style="width:35%;overflow: hidden;">
                            <span>邮箱</span>
                            <p>{{ item.email }}</p>
                        </div>
                        <div class="list-content-item" style="width:30%">
                            <span>注册时间</span>
                            <p>{{ item.addtime || '----' }}</p>
                        </div>
                    </div>
                </a-list-item>
            </a-list>
            <a-pagination @change="pageChange" :total="users_count" :pageSize="page_size" style="margin-top:20px;text-align: center;" />
        </a-card>
        <a-modal :title="modal.title" :visible="modal.visible" @ok="sendMsg()" @cancel="modal.visible = false">
            <a-form>
                <a-form-item label="信息标题" :label-col="{ span: 5 }" :wrapper-col="{ span: 16 }">
                    <a-input v-model="socket_data.title" placeholder="标题" />
                </a-form-item>
                <a-form-item label="信息内容" :label-col="{ span: 5 }" :wrapper-col="{ span: 16 }">
                    <a-textarea v-model="socket_data.content" :rows="5" placeholder="内容" />
                </a-form-item>
            </a-form>
        </a-modal>
    </div>
</template>
<script>
export default {
    components: {
        //empty
    },
    inject: ["reload"],
    data() {
        return {
            userList: [],
            status: 'all',
            userid: this.$store.state.user.info.userid,
            modal: {
                title: '群发消息',
                visible: false
            },
            socket_data: {
                title: '',
                content: '',
                send_user: '',
                get_user: ''
            },
            users_count: 0,
            page: 1,
            page_size: 10

        }
    },
    /**
     * 计算属性
     * @type {Object}
     */
    computed: {

    },
    /**
     * 数据监听
     * @type {Object}
     */
    watch: {

    },
    /**
     * 页面加载执行
     * @return {[type]} [description]
     */
    mounted() {
        this.usersCount()
        this.getUsers()
    },
    /**
     * 页面方法
     * @type {Object}
     */
    methods: {
        usersCount() {
            this.$cloud.users().count().then(res => {
                this.users_count = res
            });
        },
        getUsers() {
            this.$cloud.users().all('', this.page, this.page_size).then(res => {
                this.userList = res
            });
        },
        pageChange(res) {
            this.page = res
            this.getUsers()
        },
        statusChange(data) {
            let status = !data.status;
            this.$cloud.users().edit(data._id, { status }).then(res => {
                if (res) {
                    this.getUsers();
                }
            });
        },
        Del(id) {
            var that = this;
            this.$confirm({
                title: '确认要删除吗?',
                onOk() {
                    that.$cloud.users().remove(id).then(res => {
                        if (res) {
                            that.getUsers();
                        }
                    });
                },
                onCancel() {
                    console.log('Cancel');
                }
            });
        },
        showModal(data = null) {
            this.socket_data = {
                title: '',
                content: '',
                send_user: '',
                get_user: ''
            }
            this.socket_data.send_user = this.userid
            if (data) {
                this.modal.title = '发送消息给' + (data.nickname || data.username || '未设置昵称')
                this.socket_data.get_user = data._id
            } else {
                this.modal.title = '群发消息'
            }
            this.modal.visible = true
        },
        sendMsg() {
            let that = this
            if (this.socket_data.title && this.socket_data.content) {
                this.$cloud.messages().send(this.socket_data).then(res => {
                    if (res) {
                        // that.$cloud.socket.send({ userId: this.socket_data.send_user, get_user: this.socket_data.get_user, message: 'getmsg' })
                        that.$message.success("发送成功");
                        that.modal.visible = false
                    }

                })
            } else {
                this.$message.warning('缺少参数')
            }

        }
    }
}
</script>
<style lang="less" scoped>
.ant-avatar-lg {
    width: 48px;
    height: 48px;
    line-height: 48px;
}

.list-content {
    width: 100%;
}

.list-content-item {
    color: rgba(0, 0, 0, .45);
    display: inline-block;
    vertical-align: middle;
    font-size: 14px;
    margin-left: 30px;

    span {
        line-height: 20px;
    }

    p {
        margin-top: 4px;
        margin-bottom: 0;
        line-height: 22px;
    }
}
</style>