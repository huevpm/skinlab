<template>
    <a-card :bordered="false">
        <!-- <div class="table-page-search-wrapper">
      <a-form layout="inline">
        <a-row :gutter="48">
          <a-col :md="8" :sm="24">
            <a-form-item label="角色ID">
              <a-input placeholder="请输入" />
            </a-form-item>
          </a-col>
          <a-col :md="8" :sm="24">
            <a-form-item label="状态">
              <a-select placeholder="请选择" default-value="0">
                <a-select-option value="0">全部</a-select-option>
                <a-select-option value="1">正常</a-select-option>
                <a-select-option value="2">禁用</a-select-option>
              </a-select>
            </a-form-item>
          </a-col>
          <a-col :md="8" :sm="24">
            <span class="table-page-search-submitButtons">
              <a-button type="primary">查询</a-button>
              <a-button style="margin-left: 8px">重置</a-button>
            </span>
          </a-col>
        </a-row>
      </a-form>
    </div> -->
        <div class="table-operator">
            <a-button type="primary" icon="plus" v-popup.role>新建</a-button>
            <a-dropdown v-action:edit v-if="selectedRowKeys.length > 0">
                <a-menu slot="overlay">
                    <a-menu-item key="1">
                        <a-icon type="delete" />删除</a-menu-item>
                    <!-- lock | unlock -->
                    <a-menu-item key="2">
                        <a-icon type="lock" />锁定</a-menu-item>
                </a-menu>
                <a-button style="margin-left: 8px">
                    批量操作
                    <a-icon type="down" />
                </a-button>
            </a-dropdown>
        </div>
        <a-table :columns="columns" rowKey="_id" :dataSource="loadData">
            <template slot="status" slot-scope="text, record">
                <a-switch :checked="record.status" @change="statusChange(record)" />
            </template>
            <span slot="action" slot-scope="text, record">
                <router-link :to="{ path: '/system/perms', query: { role_id: record._id } }">
                    编辑
                </router-link>
                <a-divider type="vertical" />
                <a @click="Del(record._id)">删除</a>
            </span>
        </a-table>
    </a-card>
</template>
<script>
export default {
    name: 'TableList',
    components: {

    },
    inject: ["reload"],
    data() {
        return {

            visible: false,

            form: null,
            mdl: {},

            // 高级搜索 展开/关闭
            advanced: false,
            // 查询参数
            queryParam: {},
            // 表头
            columns: [{
                    title: '唯一识别码',
                    dataIndex: 'name'
                },
                {
                    title: '角色名称',
                    dataIndex: 'title'
                },
                {
                    title: '状态',
                    dataIndex: 'status',
                    scopedSlots: { customRender: 'status' }
                },
                {
                    title: '创建时间',
                    dataIndex: 'createTime'
                }, {
                    title: '操作',
                    width: '150px',
                    dataIndex: 'action',
                    scopedSlots: { customRender: 'action' }
                }
            ],
            // 加载数据方法 必须为 Promise 对象
            loadData: [],

            selectedRowKeys: [],
            selectedRows: []
        }
    },
    /**
     * 页面加载执行
     * @return {[type]} [description]
     */
    async mounted() {
        await this.getRoles();
    },
    methods: {
        getRoles() {
            this.$cloud.roles().all().then(result => {
                this.loadData = result
            })
        },
        handleEdit(record) {
            this.mdl = Object.assign({}, record)

            this.mdl.permissions.forEach(permission => {
                permission.actionsOptions = permission.actionEntitySet.map(action => {
                    return { label: action.describe, value: action.action, defaultCheck: action.defaultCheck }
                })
            })

            console.log(this.mdl)
            this.visible = true
        },
        handleOk() {
            // 新增/修改 成功时，重载列表
            this.$refs.table.refresh()
        },
        onChange(selectedRowKeys, selectedRows) {
            this.selectedRowKeys = selectedRowKeys
            this.selectedRows = selectedRows
        },
        toggleAdvanced() {
            this.advanced = !this.advanced
        },
        statusChange(data) {
            let status = !data.status;

            this.$cloud.roles().edit(data._id, { status }).then(res => {
                if (res) {
                    this.getRoles();
                }
            });
        },
        Del(id) {
            var that = this;
            this.$confirm({
                title: '确认要删除吗?',
                onOk() {
                    that.$cloud.roles().remove(id).then(res => {
                        if (res) {
                            that.getRoles();
                        }
                    });
                },
                onCancel() {
                    console.log('Cancel');
                }
            });
        }
    },
    watch: {
        /*
          'selectedRows': function (selectedRows) {
            this.needTotalList = this.needTotalList.map(item => {
              return {
                ...item,
                total: selectedRows.reduce( (sum, val) => {
                  return sum + val[item.dataIndex]
                }, 0)
              }
            })
          }
          */
    }
}
</script>