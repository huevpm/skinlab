<template>
    <a-card :bordered="false">
        <div class="table-operator">
            <a-button type="primary" icon="plus" v-popup.rule>创建规则</a-button>
        </div>
        <a-table rowKey="_id" :columns="columns" :dataSource="loadData">
            <template slot="status" slot-scope="text, record">
                <a-switch :checked="record.status" @change="statusChange(record)" />
            </template>
            <span slot="action" slot-scope="text, record">
                <a v-popup.rule="record" :data-id="record._id">编辑</a>
                <a-divider type="vertical" />
                <a @click="Del(record._id)">删除</a>
            </span>
        </a-table>
    </a-card>
</template>
<script>
export default {
    name: 'TableList',
    components: {

    },
    inject: ["reload"],
    data() {
        return {
            visible: false,
            labelCol: {
                xs: { span: 24 },
                sm: { span: 5 }
            },
            wrapperCol: {
                xs: { span: 24 },
                sm: { span: 16 }
            },
            form: null,
            mdl: {},

            // 高级搜索 展开/关闭
            advanced: false,
            // 查询参数
            queryParam: {},
            // 表头
            columns: [{
                    title: '规则标题',
                    dataIndex: 'title'
                },
                {
                    title: '权限名称',
                    dataIndex: 'name'
                },
                {
                    title: '表达式',
                    dataIndex: 'expression',
                    scopedSlots: { customRender: 'expression' }
                },
                {
                    title: '状态',
                    dataIndex: 'status',
                    scopedSlots: { customRender: 'status' }
                },
                {
                    title: '操作',
                    width: '150px',
                    dataIndex: 'action',
                    scopedSlots: { customRender: 'action' }
                }
            ],
            // 向后端拉取可以用的操作列表
            permissionList: null,
            // 加载数据方法 必须为 Promise 对象
            loadData: [],

            selectedRowKeys: [],
            selectedRows: []
        }
    },
    filters: {
        statusFilter(status) {
            const statusMap = {
                1: '正常',
                2: '禁用'
            }
            return statusMap[status]
        }
    },
    created() {
        this.loadPermissionList();

    },
    /**
     * 页面加载执行
     * @return {[type]} [description]
     */
    async mounted() {
        await this.getRules();
    },
    methods: {
        getRules() {
            this.$cloud.rules().all().then(result => {
                this.loadData = result
            })
        },
        loadPermissionList() {
            // permissionList
            new Promise(resolve => {
                const data = [
                    { label: '新增', value: 'add', defaultChecked: false },
                    { label: '查询', value: 'get', defaultChecked: false },
                    { label: '修改', value: 'update', defaultChecked: false },
                    { label: '列表', value: 'query', defaultChecked: false },
                    { label: '删除', value: 'delete', defaultChecked: false },
                    { label: '导入', value: 'import', defaultChecked: false },
                    { label: '导出', value: 'export', defaultChecked: false }
                ]
                setTimeout(resolve(data), 1500)
            }).then(res => {
                this.permissionList = res
            })
        },
        handleEdit(record) {
            this.mdl = Object.assign({}, record)
            console.log(this.mdl)
            this.visible = true
        },
        handleOk() {

        },
        onChange(selectedRowKeys, selectedRows) {
            this.selectedRowKeys = selectedRowKeys
            this.selectedRows = selectedRows
        },
        toggleAdvanced() {
            this.advanced = !this.advanced
        },
        statusChange(data) {
            let status = !data.status;
            this.$cloud.rules().edit(data._id, { status }).then(res => {
                if (res) {
                    this.getRules();
                }
            });
        },
        Del(id) {
            var that = this;
            this.$confirm({
                title: '确认要删除吗?',
                onOk() {
                    that.$cloud.rules().remove(id).then(res => {
                        if (res) {
                            that.getRules();
                        }
                    });
                },
                onCancel() {
                    console.log('Cancel');
                }
            });
        }
    },
    watch: {
        /*
          'selectedRows': function (selectedRows) {
            this.needTotalList = this.needTotalList.map(item => {
              return {
                ...item,
                total: selectedRows.reduce( (sum, val) => {
                  return sum + val[item.dataIndex]
                }, 0)
              }
            })
          }
          */
    }
}
</script>