<template>
    <a-card :bordered="false">
        <Roles :router="menuInfo" v-model="permList"></Roles>
        <a-divider />
        <div class="ci-perms">
            <a-button type="primary" @click="onSave">提交保存</a-button>
        </div>
    </a-card>
</template>
<script type="text/javascript">
import Roles from '#/components/Roles/Role.vue'

export default {
    components: {
        Roles
    },
    data() {
        return {
            role_id: "",
            permList: {},
            menuInfo: []
        }
    },
    /**
     * 计算属性
     * @type {Object}
     */
    computed: {

    },
    /**
     * 数据监听
     * @type {Object}
     */
    watch: {

    },
    /**
     * 页面加载执行
     * @return {[type]} [description]
     */
    async mounted() {
        this.role_id = this.$route.query.role_id;
        this.getMenus();
        this.getRole();
    },
    /**
     * 页面方法
     * @type {Object}
     */
    methods: {
        getMenus() {
            console.log("执行1")
            this.$cloud.menus().rules().then(res => {
                let toTree = {
                    parentKey: "parentId",
                    idKey: "menuId",
                    parentId: 0,
                    childrenKey: "children"
                }
                let residences = this.$cloud
                    .tree(toTree)
                    .add("key", "")
                    .add("selectable", false)
                    .add("scopedSlots", "")
                    .field("key", (value, self) => {
                        return self['name']
                    })
                    .field("scopedSlots", (value, self) => {
                        return {
                            title: "title"
                        }
                    })
                    .field("selectable", (value, self) => {
                        return false
                    })
                    .on(res)
                    .get();
                console.log("我的菜单", residences)
                this.menuInfo = residences;
            });
        },
        getRole() {
            this.$cloud.roles().get(this.role_id).then(res => {
                if (JSON.stringify(res.rules) == "{}" || !res.rules) {
                    this.permList = {};
                } else {
                    this.permList = res.rules
                }
            })
        },
        onSave() {
            if (this.role_id) {
                let data = {
                    rules: this.permList
                }
                this.$cloud.roles().edit(this.role_id,data).then(res => {
                    this.$message.success('保存成功')
                });
            } else {

            }

        }
    }
}
</script>
<style type="text/css">
.ci-perms {
    padding-left: 100px;
}
</style>