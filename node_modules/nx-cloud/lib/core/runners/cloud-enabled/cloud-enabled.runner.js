const a1_0x4ebe=['../../file-storage/file-storage','then','length','warn','cacheableOperations','defineProperty','OutputObfuscator','processInBackground','filter','getRunGroup','parseCommand','store','join','DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE','ErrorReporterApi','toISOString','throw','path','\x20isn\x27t\x20recorded','nx-cloud/lib/daemon/process-run-end','MessageReporter','writeFileSync','getCIExecutionEnv','requests','getBranch','skipNxCache','push','submitRunMetrics','pathExists','enabled','./cloud-run.api','delayedStoreRequests','obfuscate','printCacheHitsMessage','.commit','subscribe','daemon','uploadedToStorage','waitForStoreRequestsToComplete','apply','assign','../../terminal-output/message-reporter','FileStorage','stringify','Nx\x20Cloud\x20wasn\x27t\x20able\x20to\x20record\x20its\x20run.','CloudRunApi','../../terminal-output/end-of-run-message','../../../utilities/metric-logger','hash','map','local-cache-hit','env','message','getMachineInfo','error','fs-extra','find','EndOfRunMessage','exit','toString','next','Nx\x20Cloud\x20Problems','removeTrailingSlash','anyErrors','../../../utilities/nx-imports','Task\x20with\x20hash\x20','VERBOSE_LOGGING','__awaiter','../../file-storage/e2e-encryption','printMessages','CloudEnabledLifeCycle','Nx\x20Cloud\x20wasn\x27t\x20able\x20to\x20store\x20artifacts.','../../terminal-output/output-obfuscator','resolve','complete','cacheStatus','catch','startRun','maskedProperties','ACCESS_TOKEN','all','cloudEnabledTasksRunner','./id-generator','../../../utilities/remove-trailing-slash','lifeCycle','agentRunningInDistributedExecution','note','../../../utilities/nx-imports-light','getCIExecutionId','value','NX_CLOUD_DISTRIBUTED_EXECUTION_ID','forEach'];(function(_0x3d695c,_0x4ebe6c){const _0x17d4d4=function(_0x477561){while(--_0x477561){_0x3d695c['push'](_0x3d695c['shift']());}};_0x17d4d4(++_0x4ebe6c);}(a1_0x4ebe,0x166));const a1_0x17d4=function(_0x3d695c,_0x4ebe6c){_0x3d695c=_0x3d695c-0x0;let _0x17d4d4=a1_0x4ebe[_0x3d695c];return _0x17d4d4;};'use strict';var __awaiter=this&&this[a1_0x17d4('0x4d')]||function(_0x1f95d3,_0x46dc8e,_0x89f2f5,_0x22dfdf){function _0x3e4e24(_0x325138){return _0x325138 instanceof _0x89f2f5?_0x325138:new _0x89f2f5(function(_0x392c22){_0x392c22(_0x325138);});}return new(_0x89f2f5||(_0x89f2f5=Promise))(function(_0x40a426,_0x264f69){function _0x4df7e5(_0x23755f){try{_0x256f24(_0x22dfdf[a1_0x17d4('0x46')](_0x23755f));}catch(_0x1770c1){_0x264f69(_0x1770c1);}}function _0x1ef7e1(_0x150ae9){try{_0x256f24(_0x22dfdf[a1_0x17d4('0x1a')](_0x150ae9));}catch(_0x13dac1){_0x264f69(_0x13dac1);}}function _0x256f24(_0x260e0a){_0x260e0a['done']?_0x40a426(_0x260e0a[a1_0x17d4('0x7')]):_0x3e4e24(_0x260e0a[a1_0x17d4('0x7')])[a1_0x17d4('0xb')](_0x4df7e5,_0x1ef7e1);}_0x256f24((_0x22dfdf=_0x22dfdf[a1_0x17d4('0x31')](_0x1f95d3,_0x46dc8e||[]))[a1_0x17d4('0x46')]());});};Object[a1_0x17d4('0xf')](exports,'__esModule',{'value':!![]});exports[a1_0x17d4('0x5b')]=void 0x0;const fs_1=require('fs');const fs_extra_1=require(a1_0x17d4('0x41'));const path=require('path');const path_1=require(a1_0x17d4('0x1b'));const environment_1=require('../../../utilities/environment');const metric_logger_1=require(a1_0x17d4('0x39'));const remove_trailing_slash_1=require(a1_0x17d4('0x1'));const error_reporter_api_1=require('../../api/error-reporter.api');const e2e_encryption_1=require(a1_0x17d4('0x4e'));const file_storage_1=require(a1_0x17d4('0xa'));const end_of_run_message_1=require(a1_0x17d4('0x38'));const message_reporter_1=require(a1_0x17d4('0x33'));const output_obfuscator_1=require(a1_0x17d4('0x52'));const cloud_enabled_life_cycle_1=require('./cloud-enabled-life-cycle');const cloud_remote_cache_1=require('./cloud-remote-cache');const cloud_run_api_1=require(a1_0x17d4('0x28'));const id_generator_1=require(a1_0x17d4('0x0'));const {output}=require(a1_0x17d4('0x5'));const {tasksRunner,cacheDirectory}=require('../../../utilities/nx-imports');function createApi(_0x4396d6,_0x2e84a0,_0x4aa4f2){const _0x473f4a=(0x0,environment_1[a1_0x17d4('0x3f')])();return new cloud_run_api_1[(a1_0x17d4('0x37'))](_0x4396d6,_0x4aa4f2,_0x2e84a0,_0x473f4a);}function storeTaskHashes(_0x1317d6,_0xbef8d3,_0x4df593){const _0xbc16e=JSON[a1_0x17d4('0x35')](_0x1317d6[a1_0x17d4('0x3b')](_0x3a2c39=>({'taskId':_0x3a2c39['taskId'],'hash':_0x3a2c39[a1_0x17d4('0x3a')]})));if(environment_1[a1_0x17d4('0x4c')]){output[a1_0x17d4('0x4')]({'title':'Executed\x20tasks\x20with\x20hashes:\x20'+_0xbc16e});}(0x0,fs_1[a1_0x17d4('0x1f')])(path[a1_0x17d4('0x16')](_0xbef8d3,'tasks-hashes-'+_0x4df593),_0xbc16e);}function storeLocalCacheHits(_0x1f8630,_0x30b96e,_0xd01cb0){const _0x2976e7=_0x1f8630['filter'](_0xfc4afb=>_0xfc4afb[a1_0x17d4('0x55')]===a1_0x17d4('0x3c'))['map'](_0x5ef92a=>_0x5ef92a[a1_0x17d4('0x3a')]);_0x2976e7[a1_0x17d4('0x9')](_0x1b1817=>_0x30b96e[a1_0x17d4('0x15')](_0x1b1817,_0xd01cb0));}function onComplete({daemon,options,fileStorage,remoteCache,api,outputObfuscator,runStartTime,messages,endOfRunMessage,taskExecutions,versionOfNxBefore133,inner,encryptionKey,storeInCurrentProcess,distributedExecutionId,runContext}){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x1cb2c9=new Date()[a1_0x17d4('0x19')]();const _0x299233=(0x0,environment_1[a1_0x17d4('0x22')])();const _0x376ec={'command':outputObfuscator[a1_0x17d4('0x2a')]((0x0,environment_1[a1_0x17d4('0x14')])()),'startTime':runStartTime,'endTime':_0x1cb2c9,'distributedExecutionId':distributedExecutionId,'branch':_0x299233,'runGroup':(0x0,environment_1['getRunGroup'])(),'sha':_0x299233?(0x0,environment_1['extractGitSha'])():undefined,'inner':inner};const _0x3e47bc={'branch':_0x299233,'runGroup':(0x0,environment_1[a1_0x17d4('0x13')])(),'ciExecutionId':(0x0,environment_1[a1_0x17d4('0x6')])(),'ciExecutionEnv':(0x0,environment_1[a1_0x17d4('0x20')])()};if(storeInCurrentProcess){if((0x0,environment_1[a1_0x17d4('0x3')])(distributedExecutionId)){storeTaskHashes(taskExecutions,cacheDirectory,distributedExecutionId);storeLocalCacheHits(taskExecutions,remoteCache,cacheDirectory);}try{yield remoteCache[a1_0x17d4('0x30')]();}catch(_0x3cbd3b){output[a1_0x17d4('0x40')]({'title':a1_0x17d4('0x51')});messages[a1_0x17d4('0x4f')]();return![];}for(const _0x5427dd of fileStorage['storedHashes']){const _0x20b310=taskExecutions[a1_0x17d4('0x42')](_0x14087a=>_0x14087a[a1_0x17d4('0x3a')]===_0x5427dd);if(!_0x20b310){throw new Error(a1_0x17d4('0x4b')+_0x5427dd+a1_0x17d4('0x1c'));}_0x20b310[a1_0x17d4('0x2f')]=!![];}try{yield api['endRun'](_0x376ec,taskExecutions,_0x3e47bc);}catch(_0x54ecba){output[a1_0x17d4('0x40')]({'title':a1_0x17d4('0x36')});messages[a1_0x17d4('0x4f')]();return![];}yield(0x0,metric_logger_1[a1_0x17d4('0x25')])(options);}else{try{const _0x4f1178=environment_1[a1_0x17d4('0x59')]?environment_1['ACCESS_TOKEN']:options['accessToken'];const _0x1fa5f8=(0x0,id_generator_1['generateUniqueLinkId'])();const _0x413e63=require[a1_0x17d4('0x53')](a1_0x17d4('0x1d'));yield daemon[a1_0x17d4('0x11')](_0x413e63,{'encryptionKey':encryptionKey,'runnerOptions':Object[a1_0x17d4('0x32')](Object['assign']({},options),{'accessToken':_0x4f1178}),'delayedStoreRequests':remoteCache[a1_0x17d4('0x29')],'ciExecutionContext':_0x3e47bc,'runEnd':{'runData':_0x376ec,'taskExecutions':taskExecutions,'linkId':_0x1fa5f8}});runContext['runUrl']=(0x0,remove_trailing_slash_1[a1_0x17d4('0x48')])(options['url']||'https://nx.app')+'/runs/'+_0x1fa5f8;}catch(_0x1ceab3){output[a1_0x17d4('0xd')]({'title':a1_0x17d4('0x47'),'bodyLines':[_0x1ceab3[a1_0x17d4('0x3e')]||_0x1ceab3[a1_0x17d4('0x45')]()]});return![];}}if(versionOfNxBefore133){setTimeout(()=>{messages[a1_0x17d4('0x4f')]();if(!messages[a1_0x17d4('0x49')]&&!inner){endOfRunMessage[a1_0x17d4('0x2b')]();}},0x0);}else{messages['printMessages']();if(!messages['anyErrors']&&!inner){endOfRunMessage[a1_0x17d4('0x2b')]();}}return!![];});}function createLifeCycle(_0x172782,_0x2e6bac,_0x136a8e,_0x48e5ef){const _0x104ba9=new cloud_enabled_life_cycle_1[(a1_0x17d4('0x50'))](_0x172782,cacheDirectory,!![],_0x2e6bac[a1_0x17d4('0xe')]||[],_0x136a8e,_0x48e5ef);try{const {CompositeLifeCycle}=require(a1_0x17d4('0x4a'));if(!CompositeLifeCycle)return _0x104ba9;return new CompositeLifeCycle([_0x2e6bac[a1_0x17d4('0x2')],_0x104ba9]);}catch(_0x492b10){return _0x104ba9;}}function fetchUrlsForKnownHashesUpfront(_0x5d10e6,_0x44d77b,_0x17d10b,_0x1b5be7,_0x309157){return __awaiter(this,void 0x0,void 0x0,function*(){if(_0x1b5be7[a1_0x17d4('0x23')])return;let _0x48a4b9=_0x17d10b[a1_0x17d4('0x3b')](_0x40e9c4=>_0x40e9c4[a1_0x17d4('0x3a')])[a1_0x17d4('0x12')](_0xc74a9b=>!!_0xc74a9b);const _0x38d2f8=yield Promise[a1_0x17d4('0x5a')](_0x48a4b9[a1_0x17d4('0x3b')](_0x3d4862=>{const _0x53651c=(0x0,path_1[a1_0x17d4('0x16')])(cacheDirectory,_0x3d4862+a1_0x17d4('0x2c'));return(0x0,fs_extra_1[a1_0x17d4('0x26')])(_0x53651c);}));const _0x5e1efc=[];for(let _0x303ed1=0x0;_0x303ed1<_0x38d2f8[a1_0x17d4('0xc')];++_0x303ed1){if(!_0x38d2f8[_0x303ed1]){_0x5e1efc[a1_0x17d4('0x24')](_0x48a4b9[_0x303ed1]);}}if(_0x5e1efc[a1_0x17d4('0xc')]>0x0){const _0x301e81=_0x5d10e6[a1_0x17d4('0x57')](_0x309157,_0x5e1efc);for(const _0x2c6518 of _0x5e1efc){_0x44d77b[a1_0x17d4('0x21')][_0x2c6518]=_0x301e81;}}});}function cloudEnabledTasksRunner(_0x33fed7,_0xbad05f,_0x16804e,_0x1ac721=![]){var _0x7129ff;const _0xe6c1fa=process[a1_0x17d4('0x3d')][a1_0x17d4('0x8')];const _0x425ab1={'statuses':{},'scheduledTasks':[],'requests':{},'allTasks':_0x33fed7};const _0x42664c=_0xbad05f[a1_0x17d4('0x2')]===undefined;const _0x3388b1=[];const _0x3d3c69=new message_reporter_1[(a1_0x17d4('0x1e'))](_0xbad05f);const _0xd28b64=createApi(_0x3d3c69,_0xbad05f,_0x425ab1);const _0x435799=new end_of_run_message_1[(a1_0x17d4('0x43'))](_0x425ab1,_0x3388b1,_0xe6c1fa);const _0x588567=new output_obfuscator_1[(a1_0x17d4('0x10'))](_0xbad05f[a1_0x17d4('0x58')]);const _0x397dea=new Date()[a1_0x17d4('0x19')]();const _0x19f533=createLifeCycle(_0x425ab1,_0xbad05f,_0x588567,_0x3388b1);const _0x28c463=environment_1['ENCRYPTION_KEY']||_0xbad05f['encryptionKey'];const _0x49b168=new e2e_encryption_1['E2EEncryption'](_0x28c463);const _0x13bb07=new error_reporter_api_1[(a1_0x17d4('0x18'))](_0xbad05f);const _0x18eb18=(0x0,environment_1[a1_0x17d4('0x3')])(_0xe6c1fa)||!((_0x7129ff=_0x16804e[a1_0x17d4('0x2e')])===null||_0x7129ff===void 0x0?void 0x0:_0x7129ff[a1_0x17d4('0x27')]());const _0x3cd9c9=new file_storage_1[(a1_0x17d4('0x34'))](_0x49b168,_0x13bb07,_0xbad05f,'cloud-enabled-runner');const _0x18b03a=new cloud_remote_cache_1['CloudRemoteCache'](_0x3d3c69,_0xd28b64,_0x425ab1,_0x3cd9c9,_0xe6c1fa,_0x18eb18);fetchUrlsForKnownHashesUpfront(_0xd28b64,_0x425ab1,_0x33fed7,_0xbad05f,_0xe6c1fa);delete process[a1_0x17d4('0x3d')][a1_0x17d4('0x8')];const _0x24d03b=tasksRunner(_0x33fed7,Object[a1_0x17d4('0x32')](Object[a1_0x17d4('0x32')]({},_0xbad05f),{'remoteCache':_0x18b03a,'lifeCycle':_0x19f533}),_0x16804e);if(_0x24d03b['subscribe']){const {Subject}=require('rxjs/internal/Subject');const _0x3f7d2d=new Subject();_0x24d03b[a1_0x17d4('0x2d')]({'next':_0x149a2f=>_0x3f7d2d[a1_0x17d4('0x46')](_0x149a2f),'error':_0x54a1bb=>_0x3f7d2d[a1_0x17d4('0x40')](_0x54a1bb),'complete':()=>__awaiter(this,void 0x0,void 0x0,function*(){const _0x3d73bf=yield onComplete({'daemon':_0x16804e[a1_0x17d4('0x2e')],'options':_0xbad05f,'fileStorage':_0x3cd9c9,'remoteCache':_0x18b03a,'api':_0xd28b64,'outputObfuscator':_0x588567,'runStartTime':_0x397dea,'messages':_0x3d3c69,'endOfRunMessage':_0x435799,'taskExecutions':_0x3388b1,'versionOfNxBefore133':_0x42664c,'inner':_0x1ac721,'encryptionKey':_0x28c463,'storeInCurrentProcess':_0x18eb18,'runContext':_0x425ab1,'distributedExecutionId':_0xe6c1fa});if(!_0x3d73bf&&(0x0,environment_1[a1_0x17d4('0x3')])(_0xe6c1fa)){process[a1_0x17d4('0x44')](environment_1['DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE']);}_0x3f7d2d[a1_0x17d4('0x54')]();})});return _0x3f7d2d;}else{return _0x24d03b['then'](_0x308fdf=>__awaiter(this,void 0x0,void 0x0,function*(){const _0x12cc0a=yield onComplete({'daemon':_0x16804e[a1_0x17d4('0x2e')],'options':_0xbad05f,'fileStorage':_0x3cd9c9,'remoteCache':_0x18b03a,'api':_0xd28b64,'outputObfuscator':_0x588567,'runStartTime':_0x397dea,'messages':_0x3d3c69,'endOfRunMessage':_0x435799,'taskExecutions':_0x3388b1,'versionOfNxBefore133':_0x42664c,'inner':_0x1ac721,'encryptionKey':_0x28c463,'storeInCurrentProcess':_0x18eb18,'runContext':_0x425ab1,'distributedExecutionId':_0xe6c1fa});if(!_0x12cc0a&&(0x0,environment_1[a1_0x17d4('0x3')])(_0xe6c1fa)){process['exit'](environment_1[a1_0x17d4('0x17')]);}return _0x308fdf;}))[a1_0x17d4('0x56')](_0x30965c=>__awaiter(this,void 0x0,void 0x0,function*(){const _0x27f30a=yield onComplete({'daemon':_0x16804e[a1_0x17d4('0x2e')],'options':_0xbad05f,'fileStorage':_0x3cd9c9,'remoteCache':_0x18b03a,'api':_0xd28b64,'outputObfuscator':_0x588567,'runStartTime':_0x397dea,'messages':_0x3d3c69,'endOfRunMessage':_0x435799,'taskExecutions':_0x3388b1,'versionOfNxBefore133':_0x42664c,'inner':_0x1ac721,'encryptionKey':_0x28c463,'storeInCurrentProcess':_0x18eb18,'runContext':_0x425ab1,'distributedExecutionId':_0xe6c1fa});if(!_0x27f30a&&(0x0,environment_1['agentRunningInDistributedExecution'])(_0xe6c1fa)){process[a1_0x17d4('0x44')](environment_1[a1_0x17d4('0x17')]);}throw _0x30965c;}));}}exports['cloudEnabledTasksRunner']=cloudEnabledTasksRunner;