const a6_0x12dc=['message','DteArtifactStorage','startAgent','FileStorage','./invoke-tasks-using-run-many','env','Agent\x20','yargs-parser','Agent\x20was\x20terminated\x20via\x20SIGINT','./execute-tasks','We\x20have\x20detected\x20another\x20agent\x20with\x20this\x20ID\x20running\x20in\x20this\x20workspace.\x20This\x20should\x20not\x20happen.','isWorkspaceEnabled','readdirSync','getCIExecutionId','next','Starting\x20an\x20agent\x20for\x20running\x20Nx\x20tasks','DistributedAgentApi','../../../utilities/is-workspace-enabled','getRunGroup','exit','invokeTasksUsingRunMany','includes','.lock','SIGINT','value','SIGTERM','Distributed\x20Task\x20Execution\x20is\x20disabled\x20when\x20your\x20workspace\x20is\x20disabled','CIRCLECI','dte-agent','__awaiter','split','Duplicate\x20Agent\x20ID\x20Detected','note','invokeTasksUsingNxImperativeApi','catch','error','__esModule','../../../utilities/environment','getCIExecutionEnv','map','../../error/print-run-group-error','some','../../../utilities/metric-logger','This\x20can\x20also\x20be\x20a\x20false\x20positive\x20caused\x20by\x20agents\x20that\x20did\x20not\x20shut\x20down\x20correctly.','targets','encryptionKey','random','Starting\x20an\x20agent\x20for\x20running\x20Nx\x20target(s)\x20[','Nx\x20Cloud:\x20Workspace\x20is\x20disabled','length','filter','runner','Critical\x20Error\x20in\x20Agent:\x20\x22','CIRCLE_JOB','../../api/error-reporter.api','join','warn','Agent\x20was\x20terminated\x20via\x20SIGTERM','./invoke-tasks-using-nx-imperative-api','writeFileSync','tasksRunnerOptions','getCloudOptions','cacheableOperations','./distributed-agent.api','submitRunMetrics','../../../utilities/dte-artifact-storage','../../error/print-cacheable-targets-error','ErrorReporterApi','completeRunGroupWithError','Other\x20Nx\x20Cloud\x20Agents\x20Detected','executeTasks','printCacheableTargetsError','Organization\x20administrators\x20can\x20find\x20more\x20information\x20on\x20the\x20\x27Billing\x20and\x20Plans\x27\x20page\x20in\x20the\x20Nx\x20Cloud\x20Webapp','then','NX_AGENT_NAME','printRunGroupError','default','throw','End\x20all\x20currently\x20running\x20agents,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22,\x20and\x20try\x20again.','trim','existsSync','defineProperty','argv'];(function(_0x45af08,_0x12dc96){const _0x5748d7=function(_0x40117b){while(--_0x40117b){_0x45af08['push'](_0x45af08['shift']());}};_0x5748d7(++_0x12dc96);}(a6_0x12dc,0x188));const a6_0x5748=function(_0x45af08,_0x12dc96){_0x45af08=_0x45af08-0x0;let _0x5748d7=a6_0x12dc[_0x45af08];return _0x5748d7;};'use strict';var __awaiter=this&&this[a6_0x5748('0x34')]||function(_0x2fc688,_0x28ab3e,_0x810ff8,_0x5492e4){function _0x53604e(_0x9fd3c7){return _0x9fd3c7 instanceof _0x810ff8?_0x9fd3c7:new _0x810ff8(function(_0x181877){_0x181877(_0x9fd3c7);});}return new(_0x810ff8||(_0x810ff8=Promise))(function(_0x59eb53,_0x369402){function _0x25534a(_0x4254f6){try{_0x414d0b(_0x5492e4[a6_0x5748('0x25')](_0x4254f6));}catch(_0x52b2a7){_0x369402(_0x52b2a7);}}function _0x17e429(_0x17b808){try{_0x414d0b(_0x5492e4[a6_0x5748('0x11')](_0x17b808));}catch(_0x4cb2d3){_0x369402(_0x4cb2d3);}}function _0x414d0b(_0x29bf68){_0x29bf68['done']?_0x59eb53(_0x29bf68[a6_0x5748('0x2f')]):_0x53604e(_0x29bf68[a6_0x5748('0x2f')])[a6_0x5748('0xd')](_0x25534a,_0x17e429);}_0x414d0b((_0x5492e4=_0x5492e4['apply'](_0x2fc688,_0x28ab3e||[]))['next']());});};Object[a6_0x5748('0x15')](exports,a6_0x5748('0x3b'),{'value':!![]});exports[a6_0x5748('0x19')]=void 0x0;const fs_1=require('fs');const yargsParser=require(a6_0x5748('0x1e'));const dte_artifact_storage_1=require(a6_0x5748('0x5'));const environment_1=require(a6_0x5748('0x3c'));const get_cloud_options_1=require('../../../utilities/get-cloud-options');const is_workspace_enabled_1=require(a6_0x5748('0x28'));const metric_logger_1=require(a6_0x5748('0x41'));const error_reporter_api_1=require(a6_0x5748('0x4d'));const print_cacheable_targets_error_1=require(a6_0x5748('0x6'));const print_invalid_runner_error_1=require('../../error/print-invalid-runner-error');const print_run_group_error_1=require(a6_0x5748('0x3f'));const e2e_encryption_1=require('../../file-storage/e2e-encryption');const file_storage_1=require('../../file-storage/file-storage');const distributed_agent_api_1=require(a6_0x5748('0x3'));const execute_tasks_1=require(a6_0x5748('0x20'));const invoke_tasks_using_nx_imperative_api_1=require(a6_0x5748('0x51'));const invoke_tasks_using_run_many_1=require(a6_0x5748('0x1b'));const {output}=require('../../../utilities/nx-imports-light');const {initTasksRunner,cacheDirectory}=require('../../../utilities/nx-imports');const args=yargsParser(process[a6_0x5748('0x16')],{'array':[a6_0x5748('0x43')],'default':{}});if(args[a6_0x5748('0x43')]&&args[a6_0x5748('0x43')][a6_0x5748('0x48')]===0x1){args['targets']=args[a6_0x5748('0x43')][0x0][a6_0x5748('0x35')](',')[a6_0x5748('0x3e')](_0x33da14=>_0x33da14[a6_0x5748('0x13')]());}function startAgent(){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x4f1497=(0x0,environment_1['getBranch'])();const _0xd99695=(0x0,environment_1[a6_0x5748('0x29')])();const _0xea57c4=(0x0,environment_1[a6_0x5748('0x24')])();const _0x516d0e=(0x0,environment_1[a6_0x5748('0x3d')])();if(!(0x0,print_run_group_error_1['canDetectRunGroup'])(_0xd99695,_0xea57c4)){(0x0,print_run_group_error_1[a6_0x5748('0xf')])();process[a6_0x5748('0x2a')](0x1);}if(args[a6_0x5748('0x43')]&&args[a6_0x5748('0x43')]['length']){output[a6_0x5748('0x37')]({'title':a6_0x5748('0x46')+args[a6_0x5748('0x43')][a6_0x5748('0x4e')](',\x20')+']'});}else{output[a6_0x5748('0x37')]({'title':a6_0x5748('0x26')});}const {nxJson,nxCloudOptions:_0x29479c}=(0x0,get_cloud_options_1[a6_0x5748('0x1')])();function _0x5339a3(){var _0x1569f1;const _0x42fa8d=(_0x1569f1=nxJson[a6_0x5748('0x0')])===null||_0x1569f1===void 0x0?void 0x0:_0x1569f1[a6_0x5748('0x10')];if(nxJson['nxCloudAccessToken']&&!_0x42fa8d){return!![];}return(_0x42fa8d===null||_0x42fa8d===void 0x0?void 0x0:_0x42fa8d[a6_0x5748('0x4a')])==='nx-cloud'||(_0x42fa8d===null||_0x42fa8d===void 0x0?void 0x0:_0x42fa8d[a6_0x5748('0x4a')])==='@nrwl/nx-cloud';}if(!_0x5339a3()){(0x0,print_invalid_runner_error_1['printInvalidRunnerError'])();return process[a6_0x5748('0x2a')](0x1);}if(args['targets']&&args[a6_0x5748('0x43')][a6_0x5748('0x40')](_0x2aa78e=>{var _0x438752;return!((_0x438752=_0x29479c[a6_0x5748('0x2')])===null||_0x438752===void 0x0?void 0x0:_0x438752[a6_0x5748('0x2c')](_0x2aa78e));})){const _0x26c79f=args[a6_0x5748('0x43')][a6_0x5748('0x49')](_0x56a54a=>{var _0x20519f;return!((_0x20519f=_0x29479c['cacheableOperations'])===null||_0x20519f===void 0x0?void 0x0:_0x20519f[a6_0x5748('0x2c')](_0x56a54a));});(0x0,print_cacheable_targets_error_1[a6_0x5748('0xb')])(_0x26c79f);return process[a6_0x5748('0x2a')](0x1);}const _0x225c93=yield(0x0,is_workspace_enabled_1[a6_0x5748('0x22')])(_0x29479c);if(!_0x225c93){output[a6_0x5748('0x3a')]({'title':a6_0x5748('0x47'),'bodyLines':[a6_0x5748('0x31'),'',a6_0x5748('0xc')]});process['exit'](0x1);}const _0x33f8b8=getAgentName();const _0x35817b=new distributed_agent_api_1[(a6_0x5748('0x27'))](_0x29479c,_0x4f1497,_0xd99695,_0xea57c4,_0x516d0e,_0x33f8b8);createAgentLockfileAndSetUpListeners(_0x35817b,_0x29479c,_0x33f8b8);const _0x50a17b=new e2e_encryption_1['E2EEncryption'](environment_1['ENCRYPTION_KEY']||_0x29479c[a6_0x5748('0x44')]);const _0x283402=new error_reporter_api_1[(a6_0x5748('0x7'))](_0x29479c);const _0x4afc79=new dte_artifact_storage_1[(a6_0x5748('0x18'))](new file_storage_1[(a6_0x5748('0x1a'))](_0x50a17b,_0x283402,_0x29479c,a6_0x5748('0x33')),cacheDirectory);const _0x3eb471=initTasksRunner?yield(0x0,invoke_tasks_using_nx_imperative_api_1[a6_0x5748('0x38')])(_0x29479c):yield(0x0,invoke_tasks_using_run_many_1[a6_0x5748('0x2b')])();return(0x0,execute_tasks_1[a6_0x5748('0xa')])(_0x33f8b8,_0x35817b,_0x4afc79,_0x3eb471,args['targets'])[a6_0x5748('0xd')](_0x234f22=>__awaiter(this,void 0x0,void 0x0,function*(){yield(0x0,metric_logger_1[a6_0x5748('0x4')])(_0x29479c);return _0x234f22;}))[a6_0x5748('0x39')](_0x45016b=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x35817b[a6_0x5748('0x8')](a6_0x5748('0x4b')+_0x45016b[a6_0x5748('0x17')]+'\x22');throw _0x45016b;}));});}exports[a6_0x5748('0x19')]=startAgent;function getAgentName(){if(process[a6_0x5748('0x1c')][a6_0x5748('0xe')]!==undefined){return process[a6_0x5748('0x1c')][a6_0x5748('0xe')];}else if(process[a6_0x5748('0x1c')][a6_0x5748('0x32')]!==undefined&&process[a6_0x5748('0x1c')]['CIRCLE_STAGE']){return process['env']['CIRCLE_STAGE'];}else if(process['env'][a6_0x5748('0x32')]!==undefined&&process['env'][a6_0x5748('0x4c')]){return process['env'][a6_0x5748('0x4c')];}else{return a6_0x5748('0x1d')+Math['floor'](Math[a6_0x5748('0x45')]()*0x186a0);}}function createAgentLockfileAndSetUpListeners(_0x5b6794,_0xe725a3,_0x547260){const _0x3b29b9=cacheDirectory+'/lockfiles';const _0x2a3c07=_0x3b29b9+'/'+_0x547260+a6_0x5748('0x2d');if(!(0x0,fs_1[a6_0x5748('0x14')])(_0x3b29b9)){(0x0,fs_1['mkdirSync'])(_0x3b29b9,{'recursive':!![]});}const _0x3caed0=(0x0,fs_1[a6_0x5748('0x23')])(_0x3b29b9);if(_0x3caed0[a6_0x5748('0x48')]){if(_0x3caed0[a6_0x5748('0x2c')](_0x547260+a6_0x5748('0x2d'))){output[a6_0x5748('0x3a')]({'title':a6_0x5748('0x36'),'bodyLines':[a6_0x5748('0x21'),'',a6_0x5748('0x12')]});process[a6_0x5748('0x2a')](0x1);}output[a6_0x5748('0x4f')]({'title':a6_0x5748('0x9'),'bodyLines':['We\x20have\x20detected\x20other\x20agents\x20running\x20in\x20this\x20workspace.\x20This\x20can\x20cause\x20unexpected\x20behavior.','',a6_0x5748('0x42'),'If\x20you\x20believe\x20this\x20is\x20the\x20case,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22.']});}(0x0,fs_1[a6_0x5748('0x52')])(_0x2a3c07,'');process['on'](a6_0x5748('0x2a'),_0x3073e9=>{cleanupAgentLockfile(_0x2a3c07,_0x3073e9);});process['on'](a6_0x5748('0x30'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x5b6794['completeRunGroupWithError'](a6_0x5748('0x50'));cleanupAgentLockfile(_0x2a3c07,0x1);}));process['on'](a6_0x5748('0x2e'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x5b6794['completeRunGroupWithError'](a6_0x5748('0x1f'));cleanupAgentLockfile(_0x2a3c07,0x1);}));}function cleanupAgentLockfile(_0x4f4792,_0xfdc044){if((0x0,fs_1[a6_0x5748('0x14')])(_0x4f4792)){(0x0,fs_1['unlinkSync'])(_0x4f4792);process[a6_0x5748('0x2a')](_0xfdc044);}}